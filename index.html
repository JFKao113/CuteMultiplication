<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>魔王九九乘法闖關遊戲</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: sans-serif;
      background: #f0eac0;
    }

    #game {
      width: 480px;
      height: 700px;
      margin: 20px auto;
      background: url('background.jpg') no-repeat center center;
      background-size: cover;
      border: 5px solid #ffcc70;
      border-radius: 20px;
      padding: 10px;
      text-align: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    #top-half, #bottom-half {
      flex: none;
    }

    #top-half {
      padding-top: 10px;
    }

    #boss {
      height: 240px;
      background: url('boss.png') center/contain no-repeat;
      margin-bottom: 10px;
    }

    #question {
      margin: 10px 0;
      font-size: 28px;
    }

    #stage {
      font-size: 22px;
      margin: 10px;
    }

    #choices {
      display: flex;
      justify-content: space-around;
      margin: 10px 0;
    }

    .choice {
      background: #fff;
      padding: 10px 20px;
      border: 3px solid #ffa;
      border-radius: 15px;
      cursor: pointer;
      font-size: 26px;
      transition: 0.2s;
    }

    .choice:hover {
      background-color: #ffeeaa;
    }

    #hero {
      margin-top: 5px;
      height: 160px;
      background: url('hero.png') center/contain no-repeat;
    }

    #timer {
      font-size: 32px;
      color: red;
      margin-top: 5px;
    }

    #gameover {
      font-size: 24px;
      color: red;
      display: none;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="game">
    <div id="top-half">
      <div id="stage">第 <span id="level">1</span> 關</div>
      <div id="boss"></div>
      <div id="question"></div>
      <div id="timer"></div>
    </div>
    <div id="bottom-half">
      <div id="choices"></div>
      <div id="hero"></div>
      <div id="gameover"></div>
    </div>
  </div>

  <script>
    const questionEl = document.getElementById('question');
    const choicesEl = document.getElementById('choices');
    const timerEl = document.getElementById('timer');
    const levelEl = document.getElementById('level');
    const gameoverEl = document.getElementById('gameover');

    let level = 1;
    let correctAnswer = 0;
    let timer;
    let countdown = 5;
    let currentUtterance;

    function speakBoss(text) {
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
      }
      currentUtterance = new SpeechSynthesisUtterance(text);
      currentUtterance.lang = 'zh-TW';
      speechSynthesis.speak(currentUtterance);
    }

    function getNumberImage(num) {
      return num.toString().split('').map(d => `<img src="numbers/${d}.png" alt="${d}" style="height:60px;">`).join('');
    }

    function newQuestion() {
      countdown = 5;
      timerEl.innerHTML = getNumberImage(countdown);
      const a = Math.floor(Math.random() * 9) + 1;
      const b = Math.floor(Math.random() * 9) + 1;
      correctAnswer = a * b;
      questionEl.innerHTML = `${getNumberImage(a)} × ${getNumberImage(b)} = ?`;
      levelEl.textContent = level;

      speakBoss(`第${level}關，準備好囉！請在${countdown}秒內作答！`);

      const answers = new Set();
      answers.add(correctAnswer);
      while (answers.size < 3) {
        let wrong = correctAnswer + Math.floor(Math.random() * 10) - 5;
        if (wrong !== correctAnswer && wrong > 0) {
          answers.add(wrong);
        }
      }

      const answerList = Array.from(answers);
      answerList.sort(() => Math.random() - 0.5);
      choicesEl.innerHTML = '';
      answerList.forEach(ans => {
        const div = document.createElement('div');
        div.className = 'choice';
        div.innerHTML = getNumberImage(ans);
        div.onclick = () => checkAnswer(ans);
        choicesEl.appendChild(div);
      });

      clearInterval(timer);
      timer = setInterval(() => {
        countdown--;
        if (countdown >= 0) {
          timerEl.innerHTML = getNumberImage(countdown);
        }
        if (countdown === 0) {
          clearInterval(timer);
          gameOver();
        }
      }, 1000);
    }

    function checkAnswer(ans) {
      clearInterval(timer);
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
      }
      if (ans === correctAnswer) {
        level++;
        newQuestion();
      } else {
        gameOver();
      }
    }

    function gameOver() {
      gameoverEl.style.display = 'block';
      gameoverEl.textContent = `遊戲結束！你闖到了第 ${level} 關！`;
      speakBoss(`你失敗了～只闖到了第 ${level} 關！`);
      setTimeout(() => location.reload(), 5000);
    }

    window.onload = () => newQuestion();
  </script>
</body>
</html>
